<!DOCTYPE html>
<html lang="en" data-theme="auto">
<head>
  <meta charset="UTF-8" />
  <title>Type of Faith — Verse Memory Quiz</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="shared/nav.css" />
  <style>
    /* ---------- Theme tokens ---------- */
    /* Light */
    :root {
      --bg:#faf8f5; --ink:#111; --muted:#555; --accent:#8b6b3b;
      --panel:#ffffff; --border:#e9e3d7; --btn:#fff;
      --ok:#0a7a0a; --err:#b00020; --link:#1a56db;
      --banner-ok-bg:#eef8ff; --banner-ok-ink:#1a4f7a;
      --banner-err-bg:#ffeeef; --banner-err-ink:#7a1a2a;
      --opt-border:#cfc8ba; --opt-correct:#e9f8ee; --opt-correct-br:#6bcf8e;
      --opt-wrong:#fdecee; --opt-wrong-br:#e38a95;
      --shadow: 0 1px 1px rgba(0,0,0,.04), 0 4px 18px rgba(0,0,0,.06);
    }
    /* Dark */
    :root[data-theme="dark"]{
      --bg:#0f1115; --ink:#e6e6e6; --muted:#a8a8a8; --accent:#d7c3a0;
      --panel:#151922; --border:#2a2f3a; --btn:#151922;
      --ok:#6ee7a0; --err:#ff6b81; --link:#87b3ff;
      --banner-ok-bg:#142132; --banner-ok-ink:#a8c8ff;
      --banner-err-bg:#301822; --banner-err-ink:#ff9dac;
      --opt-border:#3a4252; --opt-correct:#1c2a23; --opt-correct-br:#6ee7a0;
      --opt-wrong:#2a1b20; --opt-wrong-br:#ff6b81;
      --shadow: 0 1px 1px rgba(0,0,0,.25), 0 4px 18px rgba(0,0,0,.25);
    }

    *{ box-sizing:border-box }
    body{ font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); color:var(--ink); margin:24px; }
    a{ color:var(--link) }

    select, button{ font-size:16px; padding:8px 10px; border-radius:8px; border:1px solid var(--opt-border); background:var(--btn); color:var(--ink); }
    button{ cursor:pointer; }
    button:disabled{ opacity:.65; cursor:not-allowed; }

    .card{ background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:14px; box-shadow: var(--shadow); }
    .controls{ display:flex; flex-wrap:wrap; gap:12px; align-items:center; margin-bottom:12px; }
    .right{ margin-left:auto }

    #banner{ display:none; margin:8px 0 12px; padding:8px 10px; border-radius:8px; font-size:14px; }
    #banner.ok{ display:block; background:var(--banner-ok-bg); color:var(--banner-ok-ink); }
    #banner.err{ display:block; background:var(--banner-err-bg); color:var(--banner-err-ink); }

    #categoryTitle{ color:var(--muted); font-size:14px; margin-bottom:6px; }
    #verseBox{ font-size:20px; line-height:1.6; min-height:4.2em; }
    #meta{ color:var(--muted); font-size:14px; margin-top:6px; }

    .options{ display:grid; gap:10px; margin-top:14px; }
    @media (min-width: 700px){ .options{ grid-template-columns: repeat(2, 1fr); } }
    .opt{
      text-align:left; border:1px solid var(--opt-border); background:var(--btn);
      padding:12px; border-radius:10px; transition: transform .12s ease, background .12s ease, border-color .12s ease;
    }
    .opt:hover{ transform: translateY(-1px); }
    .opt.correct{ background:var(--opt-correct); border-color:var(--opt-correct-br); }
    .opt.wrong{ background:var(--opt-wrong); border-color:var(--opt-wrong-br); }

    .row{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    .stat{ font-variant-numeric: tabular-nums; }
    .muted{ color:var(--muted) }

    /* Mode tabs */
    .mode-tabs{ display:flex; gap:0; margin-bottom:12px; }
    .mode-tab{
      flex:1; padding:10px 16px; text-align:center; cursor:pointer;
      border:1px solid var(--opt-border); background:var(--btn);
      font-weight:600; transition:background .15s, color .15s;
    }
    .mode-tab:first-child{ border-radius:8px 0 0 8px; }
    .mode-tab:last-child{ border-radius:0 8px 8px 0; border-left:none; }
    .mode-tab.active{ background:var(--accent); color:#fff; border-color:var(--accent); }
    .mode-tab:not(.active):hover{ background:var(--border); }

    /* Study mode */
    #studyPanel{ display:none; }
    #studyPanel.show{ display:block; }
    #quizPanel{ display:block; }
    #quizPanel.hide{ display:none; }

    .verse-list{ display:flex; flex-direction:column; gap:8px; max-height:500px; overflow-y:auto; }
    .verse-item{
      padding:12px; border:1px solid var(--border); border-radius:8px;
      background:var(--panel); cursor:pointer; transition:background .15s;
    }
    .verse-item:hover{ background:var(--border); }
    .verse-item.expanded{ background:var(--banner-ok-bg); }
    .verse-ref{ font-weight:600; color:var(--accent); }
    .verse-text{ margin-top:8px; font-size:15px; line-height:1.5; color:var(--ink); display:none; }
    .verse-item.expanded .verse-text{ display:block; }
    .verse-loading{ color:var(--muted); font-style:italic; }
    .study-hint{ color:var(--muted); font-size:14px; margin-bottom:12px; }

    /* Streak indicator */
    .streak-bar { display:flex; gap:4px; align-items:center; margin-top:12px; }
    .streak-dot {
      width:20px; height:20px; border-radius:50%;
      border:2px solid var(--border); background:var(--panel);
      transition: background .3s, border-color .3s;
    }
    .streak-dot.filled { background:var(--ok); border-color:var(--ok); }
    .streak-dot.current { border-color:var(--accent); box-shadow:0 0 6px var(--accent); }
    .streak-label { font-size:13px; color:var(--muted); margin-left:8px; }
  </style>
</head>
<body>
  <script src="shared/data.js"></script>
  <script src="shared/nav.js"></script>
  <script src="shared/theme.js"></script>
  <script src="shared/audio.js"></script>
  <script src="shared/achievements.js"></script>

  <!-- Mode tabs -->
  <div class="mode-tabs">
    <div class="mode-tab active" id="quizTab">Quiz Mode</div>
    <div class="mode-tab" id="studyTab">Study Mode</div>
  </div>

  <div class="controls">
    <label>Category:
      <select id="category"></select>
    </label>
    <label>Version:
      <select id="version">
        <option value="WEB" selected>WEB (World English Bible)</option>
        <option value="KJV">KJV (bible-api.com)</option>
        <option value="FBV">FBV (api.bible via proxy)</option>
        <option value="ESV">ESV (Crossway via proxy)</option>
      </select>
    </label>
    <span id="quizControls">
      <button id="newBtn">New Question</button>
      <button id="revealBtn">Reveal Answer</button>
    </span>
    <div class="right stat muted" id="score">Score: 0 / 0 · Streak: 0</div>
  </div>

  <div id="banner"></div>

  <!-- Study Panel -->
  <div id="studyPanel" class="card">
    <div class="study-hint">Click a verse reference to load and view its text. Study these before taking the quiz!</div>
    <div class="verse-list" id="verseList"></div>
  </div>

  <!-- Quiz Panel -->
  <div id="quizPanel" class="card">
    <div id="categoryTitle">All</div>
    <div id="verseBox"></div>
    <div id="meta"></div>

    <div class="options" id="options"></div>

    <div class="row" style="margin-top:14px">
      <div id="feedback" class="stat">—</div>
    </div>

    <div class="streak-bar" id="streakBar">
      <span class="streak-dot" data-idx="0"></span>
      <span class="streak-dot" data-idx="1"></span>
      <span class="streak-dot" data-idx="2"></span>
      <span class="streak-dot" data-idx="3"></span>
      <span class="streak-dot" data-idx="4"></span>
      <span class="streak-label">Streak: <span id="streakNum">0</span></span>
    </div>
  </div>

<script>
/* ---------- Quiz-specific banner (class-based for quiz styling) ---------- */
const CAT_NAMES = ["all", ...Object.keys(VERSE_CATEGORIES).sort((a,b)=>a.localeCompare(b))];
const ALL_REFS = ALL_REFERENCES;

function showQuizBanner(type,msg){
  const el = document.getElementById('banner');
  el.className = type==='error'?'err':'ok';
  el.textContent = msg||'';
  el.style.display = msg?'block':'none';
}

/* ---------- DOM ---------- */
const categoryEl = document.getElementById('category');
const versionEl  = document.getElementById('version');
const newBtn     = document.getElementById('newBtn');
const revealBtn  = document.getElementById('revealBtn');
const verseBox   = document.getElementById('verseBox');
const optionsBox = document.getElementById('options');
const bannerEl   = document.getElementById('banner');
const metaEl     = document.getElementById('meta');
const feedbackEl = document.getElementById('feedback');
const scoreEl    = document.getElementById('score');
const catTitleEl = document.getElementById('categoryTitle');
const quizTab    = document.getElementById('quizTab');
const studyTab   = document.getElementById('studyTab');
const quizPanel  = document.getElementById('quizPanel');
const studyPanel = document.getElementById('studyPanel');
const verseList  = document.getElementById('verseList');
const quizControls = document.getElementById('quizControls');

/* ---------- State ---------- */
let correctRef = null;
let allowAnswer = false;
let score = 0, total = 0, streak = 0;
let currentMode = 'quiz';
let loadedVerses = {}; // Cache for study mode

/* ---------- Helpers ---------- */
function setScore(){ scoreEl.textContent = `Score: ${score} / ${total} · Streak: ${streak}`; }

function updateStreakBar(){
  const dots = document.querySelectorAll('.streak-dot');
  const streakNum = document.getElementById('streakNum');
  streakNum.textContent = streak;
  dots.forEach((dot, idx) => {
    dot.classList.remove('filled', 'current');
    if(idx < streak) dot.classList.add('filled');
    if(idx === streak && streak < 5) dot.classList.add('current');
  });
}
function setCategoryTitle(){ const v = categoryEl.value; catTitleEl.textContent = v==='all' ? 'All' : titleCase(v); }
function pickRandom(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function sampleDistinct(pool, k, avoidSet){
  const out=[]; const used = new Set(avoidSet||[]);
  const shuffled = pool.slice().sort(()=>Math.random()-0.5);
  for (const x of shuffled){ if (used.has(x)) continue; used.add(x); out.push(x); if (out.length===k) break; }
  return out;
}

/* ---------- Fetching verses ---------- */
async function fetchViaBibleApi(ref, versionCode){
  const t = (versionCode||'WEB').toLowerCase();
  const url = `https://bible-api.com/${encodeURIComponent(ref)}?translation=${encodeURIComponent(t)}`;
  const res = await fetch(url);
  const text = await res.text();
  if (!res.ok) throw new Error(text || 'HTTP error');
  const data = JSON.parse(text);
  const verseText = Array.isArray(data.verses) && data.verses.length
    ? data.verses.map(v => v.text.trim()).join(' ')
    : (data.text || '');
  return { reference: data.reference||ref, text: verseText.replace(/\s+/g,' ').trim(), version:(versionCode||'WEB').toUpperCase(), copyright: data.copyright };
}
async function fetchViaProxy(ref, versionCode){
  const url = `http://127.0.0.1:8000/verse?ref=${encodeURIComponent(ref)}&version=${encodeURIComponent(versionCode)}`;
  const res = await fetch(url);
  const text = await res.text();
  if (!res.ok) throw new Error(text||'Proxy error');
  return JSON.parse(text);
}
async function getVerse(ref, versionCode){
  try{
    if (['FBV','ESV'].includes(versionCode)) return await fetchViaProxy(ref, versionCode);
    return await fetchViaBibleApi(ref, versionCode);
  } catch(e){
    if (['KJV','WEB'].includes(versionCode)){
      showQuizBanner('error', 'Verse provider unavailable. Try again or switch version.');
    } else {
      showQuizBanner('error', 'Proxy/Key required for this version. Start FastAPI or change version.');
    }
    throw e;
  }
}

/* ---------- Quiz logic ---------- */
async function newQuestion(){
  allowAnswer = false;
  feedbackEl.textContent = '—';
  optionsBox.innerHTML = '';
  verseBox.textContent = '';
  metaEl.textContent = '';
  metaEl.style.visibility = 'hidden';
  setCategoryTitle();
  showQuizBanner('', '');

  const cat = categoryEl.value;
  const ver = (versionEl.value||'WEB').toUpperCase();

  const pool = (cat==='all') ? ALL_REFS : (VERSE_CATEGORIES[cat] || []);
  if (!pool.length){ showQuizBanner('error','No verses found for this category.'); return; }
  correctRef = pickRandom(pool);

  let data;
  try{ data = await getVerse(correctRef, ver); }
  catch(e){ console.error(e); return; }

  verseBox.textContent = data.text || '';
  metaEl.textContent = `${data.reference||correctRef} (${(data.version||ver).toUpperCase()})`;

  const distractPool = (cat==='all') ? ALL_REFS : pool;
  const distractors = sampleDistinct(distractPool, 3, new Set([correctRef]));
  const choices = [correctRef, ...distractors].sort(()=>Math.random()-0.5);

  for (const ref of choices){
    const btn = document.createElement('button');
    btn.className = 'opt';
    btn.textContent = ref;
    btn.addEventListener('click', ()=> checkAnswer(btn, ref));
    optionsBox.appendChild(btn);
  }
  allowAnswer = true;
}

function checkAnswer(btn, ref){
  if (!allowAnswer) return;
  allowAnswer = false; total += 1;

  const buttons = Array.from(document.querySelectorAll('.opt'));
  for (const b of buttons){
    b.disabled = true;
    if (b.textContent.trim() === correctRef) b.classList.add('correct');
  }

  if (ref === correctRef){
    score += 1; streak += 1;
    feedbackEl.textContent = '✅ Correct!';
    TofAudio.playComplete();
  } else {
    streak = 0;
    feedbackEl.textContent = `❌ Incorrect. Correct answer: ${correctRef}`;
    btn.classList.add('wrong');
    TofAudio.playError();
  }
  setScore();
  updateStreakBar();
  metaEl.style.visibility = 'visible';
}

/* ---------- Mode switching ---------- */
function setMode(mode){
  currentMode = mode;
  if(mode === 'quiz'){
    quizTab.classList.add('active');
    studyTab.classList.remove('active');
    quizPanel.classList.remove('hide');
    studyPanel.classList.remove('show');
    quizControls.style.display = '';
    scoreEl.style.display = '';
  } else {
    studyTab.classList.add('active');
    quizTab.classList.remove('active');
    quizPanel.classList.add('hide');
    studyPanel.classList.add('show');
    quizControls.style.display = 'none';
    scoreEl.style.display = 'none';
    renderStudyList();
  }
  showQuizBanner('','');
}

/* ---------- Study mode ---------- */
function renderStudyList(){
  const cat = categoryEl.value;
  const verses = (cat === 'all') ? ALL_REFS : (VERSE_CATEGORIES[cat] || []);

  if(!verses.length){
    verseList.innerHTML = '<div class="muted">No verses in this category.</div>';
    return;
  }

  verseList.innerHTML = verses.map(ref => {
    const cached = loadedVerses[ref];
    const textContent = cached
      ? `<div class="verse-text">${cached}</div>`
      : '<div class="verse-text verse-loading">Click to load verse...</div>';
    return `<div class="verse-item" data-ref="${ref}">
      <div class="verse-ref">${ref}</div>
      ${textContent}
    </div>`;
  }).join('');

  // Add click handlers
  verseList.querySelectorAll('.verse-item').forEach(item => {
    item.addEventListener('click', () => toggleVerseItem(item));
  });
}

async function toggleVerseItem(item){
  const ref = item.dataset.ref;
  const wasExpanded = item.classList.contains('expanded');

  // Collapse all others
  verseList.querySelectorAll('.verse-item').forEach(el => el.classList.remove('expanded'));

  if(wasExpanded) return; // Just collapse

  item.classList.add('expanded');

  // Load verse if not cached
  if(!loadedVerses[ref]){
    const textEl = item.querySelector('.verse-text');
    textEl.textContent = 'Loading...';
    textEl.classList.add('verse-loading');

    try {
      const ver = (versionEl.value || 'WEB').toUpperCase();
      const data = await getVerse(ref, ver);
      loadedVerses[ref] = data.text;
      textEl.textContent = data.text;
      textEl.classList.remove('verse-loading');
    } catch(e) {
      textEl.textContent = 'Failed to load verse. Try again.';
      textEl.classList.remove('verse-loading');
    }
  }
}

/* ---------- Init ---------- */
(function init(){
  initTheme();

  categoryEl.innerHTML = CAT_NAMES.map(c => `<option value="${c}">${c==='all'?'All':titleCase(c)}</option>`).join('');
  setScore(); setCategoryTitle(); updateStreakBar();

  // Mode tab listeners
  quizTab.addEventListener('click', () => setMode('quiz'));
  studyTab.addEventListener('click', () => setMode('study'));

  newBtn.addEventListener('click', newQuestion);
  revealBtn.addEventListener('click', ()=>{
    if (!correctRef) return;
    Array.from(document.querySelectorAll('.opt')).forEach(b=>{
      b.disabled = true;
      if (b.textContent.trim()===correctRef) b.classList.add('correct');
    });
    metaEl.style.visibility='visible';
    allowAnswer=false;
  });
  categoryEl.addEventListener('change', () => {
    if(currentMode === 'quiz') newQuestion();
    else renderStudyList();
  });
  versionEl.addEventListener('change', () => {
    loadedVerses = {}; // Clear cache when version changes
    if(currentMode === 'quiz') newQuestion();
    else renderStudyList();
  });
  newQuestion();
})();
</script>
</body>
</html>
