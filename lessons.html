<!DOCTYPE html>
<html lang="en" data-theme="auto">
<head>
  <meta charset="UTF-8" />
  <title>Type of Faith — Lessons</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' font-size='90'%3E%F0%9F%93%96%3C/text%3E%3C/svg%3E">
  <link rel="stylesheet" href="shared/nav.css" />
  <style>
    /* Light theme */
    :root { --bg:#0f1115; --ink:#e6e6e6; --muted:#a8a8a8; --ok:#6ee7a0; --err:#ff6b81; --accent:#d7c3a0;
            --panel:#151922; --border:#2a2f3a; --banner-bg:#1d2430; --link:#87b3ff; --input-border:#2b3240; --btn-border:#3a4252; }
    :root[data-theme="light"] { --bg:#faf8f5; --ink:#111; --muted:#555; --ok:#0a7a0a; --err:#b00020; --accent:#8b6b3b;
            --panel:#fff; --border:#eee; --banner-bg:#fff7e6; --link:#1a56db; --input-border:#ddd; --btn-border:#ccc; }

    *{ box-sizing:border-box }
    body{ font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); color:var(--ink); margin:24px; }
    a{ color:var(--link) }
    .spacer{ flex:1 }
    select,button,input[type="number"]{ font-size:16px; padding:8px 10px; }
    button{ cursor:pointer; border:1px solid var(--btn-border); background:var(--panel); color:var(--ink); border-radius:6px; }
    button:active{ transform:translateY(1px) }
    .card{ background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:14px; }
    #banner{ font-size:14px; color:var(--accent); background:var(--banner-bg); padding:6px 8px; border-radius:6px; display:none; margin:8px 0; }

    /* Keyboard */
    #keyboard .krow{ margin:2px 0; display:flex; gap:6px; justify-content:center }
    #keyboard .key{
      display:inline-block; min-width:24px; padding:8px 10px; text-align:center;
      border:1px solid var(--border); border-radius:8px; background:var(--panel);
    }
    #keyboard .key.wide{ min-width:60px; font-size:12px; }
    #keyboard .key.space{ min-width:220px; font-size:12px; }
    [data-finger="lp"]{ background:#ffe7e7 } [data-finger="lr"]{ background:#ffeeda }
    [data-finger="lm"]{ background:#fff7cc } [data-finger="li"]{ background:#eaffd1 }
    [data-finger="ri"]{ background:#e0f3ff } [data-finger="rm"]{ background:#eae0ff }
    [data-finger="rr"]{ background:#f5e0ff } [data-finger="rp"]{ background:#fbe0ef }
    .highlight{ outline:2px solid var(--accent) }
    #incorrect { color:#fff; background:var(--err); border-radius:2px; padding:0 1px; }
    #input.error-state {
      background: color-mix(in srgb, var(--err) 10%, var(--panel));
      border-color: var(--err);
      box-shadow: 0 2px 0 var(--err);
    }
    .muted{ color:var(--muted) }
    .row{ display:flex; gap:10px; align-items:center }

    /* Centering & stack */
    .stack-center { display:flex; flex-direction:column; align-items:center; }
    .tips { max-width:820px; width:100%; }
    .drill { max-width:820px; width:100%; margin-top:20px; }

    /* Drill navigation */
    #drillNav { display:flex; align-items:center; gap:10px; margin-top:10px; flex-wrap:wrap; }
    #drillNav .drill-label { font-weight:600; white-space:nowrap; }
    .drill-dots { display:flex; gap:6px; align-items:center; }
    .drill-dot { width:12px; height:12px; border-radius:50%; border:2px solid var(--accent); background:transparent; cursor:pointer; transition:background .2s; }
    .drill-dot.done { background:var(--ok); border-color:var(--ok); }
    .drill-dot.current { background:var(--accent); border-color:var(--accent); }
    #drillNav button { font-size:13px; padding:4px 10px; }

    /* Lesson complete banner */
    #lessonCompleteBanner { display:none; text-align:center; margin-top:10px; padding:12px; background:var(--banner-bg); border-radius:8px; }
    #lessonCompleteBanner .complete-text { font-size:16px; font-weight:700; color:var(--ok); margin-bottom:8px; }
    #lessonCompleteBanner button { font-size:14px; padding:6px 16px; }

    /* Lesson tracker */
    #lessonTracker { margin-bottom:12px; }
    .tracker-toggle { font-size:14px; cursor:pointer; background:none; border:none; color:var(--link); padding:0; text-decoration:underline; }
    .tracker-grid { display:none; margin-top:10px; }
    .tracker-grid.open { display:block; }
    .lesson-row { display:flex; align-items:center; gap:10px; padding:6px 8px; border-radius:6px; cursor:pointer; font-size:14px; transition:background .15s; }
    .lesson-row:hover { background:var(--border); }
    .lesson-row.active { outline:2px solid var(--accent); }
    .lesson-row .lr-num { font-weight:700; min-width:24px; text-align:right; }
    .lesson-row .lr-title { flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    .lesson-row .lr-drills { color:var(--muted); min-width:40px; text-align:center; }
    .lesson-row .lr-acc { color:var(--muted); min-width:50px; text-align:center; }
    .lesson-row .lr-status { min-width:20px; text-align:center; }

    /* Skin tone selector */
    .skin-selector { display:flex; gap:6px; align-items:center; margin:12px 0; }
    .skin-selector label { font-size:14px; color:var(--muted); }
    .skin-btn {
      width:28px; height:28px; border-radius:50%; border:2px solid transparent;
      cursor:pointer; transition:border-color .2s, transform .15s;
    }
    .skin-btn:hover { transform:scale(1.1); }
    .skin-btn.selected { border-color:var(--accent); }
    .skin-btn[data-tone="light"] { background:#FFDBAC; }
    .skin-btn[data-tone="medium-light"] { background:#F1C27D; }
    .skin-btn[data-tone="medium"] { background:#E0AC69; }
    .skin-btn[data-tone="medium-dark"] { background:#C68642; }
    .skin-btn[data-tone="dark"] { background:#8D5524; }

    /* Hand diagrams */
    .hands-container {
      display:flex; justify-content:center; gap:40px; margin:16px 0;
      --hand-color:#F1C27D;
    }
    .hand {
      display:flex; flex-direction:column; align-items:center;
    }
    .hand-label { font-size:12px; color:var(--muted); margin-bottom:6px; }
    .fingers {
      display:flex; gap:4px; align-items:flex-end;
    }
    .finger {
      display:flex; flex-direction:column; align-items:center; gap:2px;
    }
    .finger-tip {
      width:20px; height:28px; border-radius:10px 10px 6px 6px;
      background:var(--hand-color); border:1px solid rgba(0,0,0,0.15);
      transition:background .15s, transform .15s, box-shadow .15s;
    }
    .finger.pinky .finger-tip { height:22px; width:16px; }
    .finger.ring .finger-tip { height:30px; width:18px; }
    .finger.middle .finger-tip { height:34px; width:20px; }
    .finger.index .finger-tip { height:30px; width:19px; }
    .finger.thumb .finger-tip { height:22px; width:22px; border-radius:50%; margin-top:8px; }
    .finger.active .finger-tip {
      background:var(--accent);
      transform:translateY(-4px);
      box-shadow:0 4px 8px rgba(0,0,0,0.2);
    }
    .finger-key {
      font-size:9px; color:var(--muted); margin-top:2px;
      opacity:0; transition:opacity .15s;
    }
    .finger.active .finger-key { opacity:1; color:var(--accent); font-weight:600; }
    .palm {
      width:90px; height:30px; background:var(--hand-color);
      border-radius:0 0 20px 20px; border:1px solid rgba(0,0,0,0.15);
      border-top:none; margin-top:-2px;
    }
    .hand.right .fingers { flex-direction:row-reverse; }
    .hand.right .thumb { order:-1; }

    /* Race track */
    .race-track { margin:12px 0; padding:6px 12px; background:var(--panel); border:1px solid var(--border); border-radius:8px; }
    .track-lane { position:relative; height:40px; background:color-mix(in srgb, var(--border) 50%, transparent); border-radius:20px; overflow:hidden; }
    .race-avatar { position:absolute; top:50%; transform:translateY(-50%); left:0; width:36px; height:36px; border-radius:50%; object-fit:cover; z-index:2; transition:left 0.3s ease-out; }
    .finish-line { position:absolute; right:0; top:0; bottom:0; width:4px; background:repeating-linear-gradient(to bottom, var(--ink) 0px, var(--ink) 4px, var(--panel) 4px, var(--panel) 8px); border-right:2px solid var(--ok); z-index:1; }
    .race-pct { position:absolute; right:12px; top:50%; transform:translateY(-50%); font-size:13px; font-weight:600; color:var(--muted); z-index:3; pointer-events:none; }
  </style>
</head>
<body>
  <script src="shared/nav.js"></script>
  <script src="shared/theme.js"></script>

  <div id="banner"></div>

  <!-- Lesson selector -->
  <div class="card" style="margin-bottom:12px">
    <div class="row">
      <strong>Lesson</strong>
      <select id="lessonSelect"></select>
      <button id="startBtn">Start</button>
      <button id="resetBtn" title="Clear progress for this lesson">Reset Progress</button>
      <span class="spacer"></span>
      <span class="muted">Tip: Aim for ≥95% accuracy before speeding up.</span>
    </div>
    <div id="lessonText" style="margin-top:8px"></div>
  </div>

  <!-- Lesson progress tracker -->
  <div id="lessonTracker" class="card" style="margin-bottom:12px">
    <button class="tracker-toggle" id="trackerToggle">Show Lesson Progress</button>
    <div class="tracker-grid" id="trackerGrid"></div>
  </div>

  <!-- Keyboard & Drill stacked and centered -->
  <div class="card stack-center">
    <div style="font-weight:700; margin-bottom:8px;">Keyboard & Finger Map</div>

    <!-- Keyboard -->
    <div id="keyboard" aria-label="Keyboard diagram">
      <div class="krow">
        <span class="key" data-finger="lp" data-key="1">1</span><span class="key" data-finger="lr" data-key="2">2</span><span class="key" data-finger="lm" data-key="3">3</span><span class="key" data-finger="li" data-key="4">4</span><span class="key" data-finger="li" data-key="5">5</span>
        <span class="key" data-finger="ri" data-key="6">6</span><span class="key" data-finger="ri" data-key="7">7</span><span class="key" data-finger="rm" data-key="8">8</span><span class="key" data-finger="rr" data-key="9">9</span><span class="key" data-finger="rp" data-key="0">0</span>
      </div>
      <div class="krow">
        <span class="key" data-finger="lp" data-key="q">Q</span><span class="key" data-finger="lr" data-key="w">W</span><span class="key" data-finger="lm" data-key="e">E</span><span class="key" data-finger="li" data-key="r">R</span><span class="key" data-finger="li" data-key="t">T</span>
        <span class="key" data-finger="ri" data-key="y">Y</span><span class="key" data-finger="ri" data-key="u">U</span><span class="key" data-finger="rm" data-key="i">I</span><span class="key" data-finger="rr" data-key="o">O</span><span class="key" data-finger="rp" data-key="p">P</span>
      </div>
      <div class="krow">
        <span class="key" data-finger="lp" data-key="a">A</span><span class="key" data-finger="lr" data-key="s">S</span><span class="key" data-finger="lm" data-key="d">D</span><span class="key" data-finger="li" data-key="f">F</span><span class="key" data-finger="li" data-key="g">G</span>
        <span class="key" data-finger="ri" data-key="h">H</span><span class="key" data-finger="ri" data-key="j">J</span><span class="key" data-finger="rm" data-key="k">K</span><span class="key" data-finger="rr" data-key="l">L</span><span class="key" data-finger="rp" data-key=";">;</span><span class="key" data-finger="rp" data-key="'">'</span>
      </div>
      <div class="krow">
        <span class="key wide" data-finger="lp" data-key="lshift">Shift</span><span class="key" data-finger="lp" data-key="z">Z</span><span class="key" data-finger="lr" data-key="x">X</span><span class="key" data-finger="lm" data-key="c">C</span><span class="key" data-finger="li" data-key="v">V</span><span class="key" data-finger="li" data-key="b">B</span>
        <span class="key" data-finger="ri" data-key="n">N</span><span class="key" data-finger="ri" data-key="m">M</span><span class="key" data-finger="rm" data-key=",">,</span><span class="key" data-finger="rr" data-key=".">.</span><span class="key" data-finger="rp" data-key="/">/</span><span class="key wide" data-finger="rp" data-key="rshift">Shift</span>
      </div>
      <div class="krow">
        <span class="key space" data-key=" ">Space</span>
      </div>
    </div>

    <!-- Skin tone selector -->
    <div class="skin-selector">
      <label>Skin tone:</label>
      <button class="skin-btn" data-tone="light" title="Light"></button>
      <button class="skin-btn" data-tone="medium-light" title="Medium-Light"></button>
      <button class="skin-btn selected" data-tone="medium" title="Medium"></button>
      <button class="skin-btn" data-tone="medium-dark" title="Medium-Dark"></button>
      <button class="skin-btn" data-tone="dark" title="Dark"></button>
    </div>

    <!-- Hand diagrams -->
    <div class="hands-container" id="handsContainer">
      <div class="hand left">
        <div class="hand-label">Left Hand</div>
        <div class="fingers">
          <div class="finger pinky" data-finger="lp"><div class="finger-tip"></div><span class="finger-key">A</span></div>
          <div class="finger ring" data-finger="lr"><div class="finger-tip"></div><span class="finger-key">S</span></div>
          <div class="finger middle" data-finger="lm"><div class="finger-tip"></div><span class="finger-key">D</span></div>
          <div class="finger index" data-finger="li"><div class="finger-tip"></div><span class="finger-key">F</span></div>
          <div class="finger thumb"><div class="finger-tip"></div><span class="finger-key"></span></div>
        </div>
        <div class="palm"></div>
      </div>
      <div class="hand right">
        <div class="hand-label">Right Hand</div>
        <div class="fingers">
          <div class="finger thumb"><div class="finger-tip"></div><span class="finger-key"></span></div>
          <div class="finger index" data-finger="ri"><div class="finger-tip"></div><span class="finger-key">J</span></div>
          <div class="finger middle" data-finger="rm"><div class="finger-tip"></div><span class="finger-key">K</span></div>
          <div class="finger ring" data-finger="rr"><div class="finger-tip"></div><span class="finger-key">L</span></div>
          <div class="finger pinky" data-finger="rp"><div class="finger-tip"></div><span class="finger-key">;</span></div>
        </div>
        <div class="palm"></div>
      </div>
    </div>

    <!-- Tips -->
    <ul class="muted tips" style="margin-top:12px;">
      <li>Keep wrists straight and relaxed. Elbows at ~90°.</li>
      <li>Place index fingers on F and J (feel the bumps).</li>
      <li>Eyes on screen; return to home row after each key.</li>
    </ul>

    <!-- Drill: full-width block UNDER keyboard -->
    <div class="card drill" aria-label="Typing drill">
      <div><strong>Drill</strong> <span class="muted" style="margin-left:12px">Goal: 95%+ accuracy</span></div>
      <div style="font-size:20px; margin-top:8px;">
        <span id="typed" style="color:var(--ok)"></span><span id="incorrect"></span><span id="remain" style="color:var(--muted)"></span>
      </div>
      <div class="race-track">
        <div class="track-lane">
          <img id="raceAvatar" class="race-avatar" src="" alt="avatar" />
          <span id="racePct" class="race-pct">0%</span>
          <div class="finish-line"></div>
        </div>
      </div>
      <input id="input" placeholder="Type the drill here..." autocomplete="off" spellcheck="false" style="width:100%; font-size:18px; margin-top:8px">
      <div id="stats" class="muted" style="margin-top:8px">WPM: 0 · Accuracy: 100% · Errors: 0</div>
      <div id="drillNav"></div>
      <div id="lessonCompleteBanner">
        <div class="complete-text">Lesson complete!</div>
        <button id="nextLessonBtn">Next Lesson</button>
      </div>
    </div>
  </div>

  <script>
    // --- Avatars ---
    const AVATARS = [
      { id: "moses", name: "Moses", src: "assets/avatars/moses-2d.png" },
      { id: "david", name: "David & Goliath", src: "assets/avatars/david-and-goliath-2d.png" },
      { id: "elijah", name: "Elijah", src: "assets/avatars/elijah-2d.png" },
      { id: "jonah", name: "Jonah", src: "assets/avatars/jonah-2d.png" },
      { id: "noahs-ark", name: "Noah's Ark", src: "assets/avatars/noahs-ark-2d.png" },
      { id: "burning-bush", name: "Burning Bush", src: "assets/avatars/burning-bush-2d.png" },
      { id: "ten-commandments", name: "Commandments", src: "assets/avatars/ten-commandments-2d.png" },
    ];

    function getSelectedAvatar() {
      const saved = localStorage.getItem("tof_avatar");
      return AVATARS.find(a => a.id === saved) || AVATARS[0];
    }

    // --- Lessons data ---
    const LESSONS = [
      { id:"home-index", title:"Home Row — Index Fingers (F, J)",
        text:"Place your index fingers on F and J — feel the small bumps. Keep wrists floating, shoulders relaxed. Only move the finger that types; the others stay on home row.",
        drills:[
          { name:"F & J Intro", text:"fff jjj fj jf fjf jfj ffjj jjff" },
          { name:"F & J Patterns", text:"fj jf ff jj fjfj jfjf fj fj jf jf" },
          { name:"F & J Speed", text:"fff jjj fjfj jfjf ffjj jjff fjfjfj" }
        ]},
      { id:"home-middle-ring", title:"Home Row — Middle & Ring Fingers (D, K, S, L)",
        text:"Middle fingers rest on D and K; ring fingers on S and L. Strike each key with a quick tap and snap back to home position.",
        drills:[
          { name:"D & K", text:"ddd kkk dk kd dkdk kdkd" },
          { name:"S & L", text:"sss lll sl ls slsl lsls" },
          { name:"Mixed Drill", text:"sd kl sdk lkj sdkl lkds fdjk" }
        ]},
      { id:"home-pinky", title:"Home Row — Pinky Fingers (A, ;)",
        text:"Pinky fingers cover A and semicolon. Keep them curved and relaxed — pinkies are weaker, so focus on accuracy over speed.",
        drills:[
          { name:"A & ;", text:"aaa ;;; a; ;a a;a; ;a;a" },
          { name:"Full Home Row", text:"asdf ;lkj asdf ;lkj fdsa jkl;" },
          { name:"Home Row Words", text:"sad lad fall flask; salad; lass ask" }
        ]},
      { id:"home-words", title:"Home Row — Full Row Words",
        text:"Time to type real words using only home-row keys. Maintain a steady rhythm — accuracy first, speed will follow.",
        drills:[
          { name:"Short Words", text:"ask all fall flask salad shall dash" },
          { name:"More Words", text:"glad lads flask lass add all dad sad" },
          { name:"Phrases", text:"a lad asks a lass; a sad fall; all shall ask dad" }
        ]},
      { id:"top-index", title:"Top Row — Index Fingers (R, T, Y, U)",
        text:"Reach up from F to R and T; from J to Y and U. Keep your wrist still — only your finger moves up and back.",
        drills:[
          { name:"Reach Drill", text:"fff rrr ftf rfr ttt yyy juj jyj" },
          { name:"Top Row Words", text:"true Ruth year fury rust try yet rut" },
          { name:"Phrases", text:"Ruth truly trusts God; try hard; year after year" }
        ]},
      { id:"top-others", title:"Top Row — Middle, Ring, Pinky (E, I, W, O, Q, P)",
        text:"Extend each finger straight up to the top row and return. E and I are the most common — build a smooth reach for them.",
        drills:[
          { name:"Reach Patterns", text:"ded kik sws lol aqa ;p;" },
          { name:"Top Row Words", text:"wipe quote power poetry queue" },
          { name:"Phrases", text:"speak wisely; write proper poetry; quiet power" }
        ]},
      { id:"bottom-index", title:"Bottom Row — Index Fingers (V, B, N, M)",
        text:"Reach down from F to V and B; from J to N and M. Curl the finger downward — do not move your whole hand.",
        drills:[
          { name:"Reach Drill", text:"fvf fbf jnj jmj vbvb nmnm" },
          { name:"Bottom Row Words", text:"brave venom born name vine man" },
          { name:"Phrases", text:"brave men borne vast burdens; name every vine" }
        ]},
      { id:"bottom-others", title:"Bottom Row — Middle, Ring, Pinky (C, X, Z, ., ,, /)",
        text:"These keys are less frequent but still important. Reach down carefully and return to home row after each keystroke.",
        drills:[
          { name:"Reach Patterns", text:"dcd sxs aza k,k l.l ;/;" },
          { name:"Punctuated Words", text:"zeal, grace. exact. zinc, fox/cub" },
          { name:"Phrases", text:"exercise grace, seek exact justice. love/peace." }
        ]},
      { id:"capitals", title:"Capital Letters & Shift Key",
        text:"Hold the opposite Shift key: to capitalize a left-hand letter, use Right Shift, and vice versa. Keep the non-shifting hand on home row.",
        drills:[
          { name:"Proper Nouns", text:"God Lord Jesus Faith Hope Love Grace" },
          { name:"Short Sentence", text:"In the beginning God created Adam and Eve." },
          { name:"Bible Figures", text:"Moses led Israel. David fought Goliath. Paul wrote Romans." }
        ]},
      { id:"numbers", title:"Numbers & Top Row (1-0)",
        text:"Numbers live above the letter keys. Reach straight up from home row. Practice each number slowly — accuracy matters more than speed.",
        drills:[
          { name:"All Digits", text:"111 222 333 444 555 666 777 888 999 000" },
          { name:"Bible Numbers", text:"12 tribes, 10 plagues, 40 days, 7 seals, 3 crosses" },
          { name:"Verse References", text:"Genesis 1:1 John 3:16 Psalm 23:1 Romans 8:28 Isaiah 40:31" }
        ]},
      { id:"common-words", title:"Common Words & Flow",
        text:"These are the most-typed words in English. Build speed by training your fingers to fire common patterns automatically.",
        drills:[
          { name:"Frequent Words", text:"the and for that with this from have been will" },
          { name:"Faith Words", text:"faith hope love grace mercy truth light peace joy" },
          { name:"Psalm 23 Flow", text:"the Lord is my shepherd I shall not want he leads me" },
          { name:"John 3:16 Flow", text:"for God so loved the world that he gave his only son" }
        ]},
      { id:"bible-verses", title:"Bible Verse Practice",
        text:"Full verse typing — the ultimate test. Focus on steady rhythm and accuracy. Let the words sink in as you type them.",
        drills:[
          { name:"Genesis 1:1", text:"In the beginning God created the heavens and the earth." },
          { name:"Psalm 23:1", text:"The Lord is my shepherd; I shall not want." },
          { name:"John 3:16", text:"For God so loved the world, that he gave his only begotten Son." },
          { name:"Proverbs 3:5", text:"Trust in the Lord with all your heart and lean not on your own understanding." }
        ]}
    ];

    // --- DOM ---
    const bannerEl = document.getElementById("banner");
    const lessonSelect = document.getElementById("lessonSelect");
    const lessonText = document.getElementById("lessonText");
    const startBtn = document.getElementById("startBtn");
    const resetBtn = document.getElementById("resetBtn");
    const typedEl = document.getElementById("typed");
    const incorrectEl = document.getElementById("incorrect");
    const remainEl = document.getElementById("remain");
    const inputEl = document.getElementById("input");
    const statsEl = document.getElementById("stats");
    const drillNavEl = document.getElementById("drillNav");
    const lessonCompleteBanner = document.getElementById("lessonCompleteBanner");
    const nextLessonBtn = document.getElementById("nextLessonBtn");
    const trackerToggle = document.getElementById("trackerToggle");
    const trackerGrid = document.getElementById("trackerGrid");
    const raceAvatar = document.getElementById("raceAvatar");
    const racePct = document.getElementById("racePct");
    const handsContainer = document.getElementById("handsContainer");

    function showLessonBanner(type,msg){
      bannerEl.textContent = msg||"";
      bannerEl.style.display = msg? "block":"none";
      bannerEl.style.color = (type==="error")? "var(--err)" : (type==="success")? "var(--ok)" : "var(--accent)";
    }

    // --- Skin tone handling ---
    const SKIN_TONES = {
      'light': '#FFDBAC',
      'medium-light': '#F1C27D',
      'medium': '#E0AC69',
      'medium-dark': '#C68642',
      'dark': '#8D5524'
    };

    function setSkinTone(tone) {
      localStorage.setItem('tof_skin_tone', tone);
      handsContainer.style.setProperty('--hand-color', SKIN_TONES[tone]);
      document.querySelectorAll('.skin-btn').forEach(btn => {
        btn.classList.toggle('selected', btn.dataset.tone === tone);
      });
    }

    function initSkinTone() {
      const saved = localStorage.getItem('tof_skin_tone') || 'medium';
      setSkinTone(saved);
      document.querySelectorAll('.skin-btn').forEach(btn => {
        btn.addEventListener('click', () => setSkinTone(btn.dataset.tone));
      });
    }

    // --- Race track ---
    function updateRaceTrack(correctChars, totalChars) {
      if (!totalChars) return;
      const progress = correctChars / totalChars;
      const pct = Math.round(progress * 100);
      const trackLane = document.querySelector(".track-lane");
      const maxLeft = trackLane.offsetWidth - raceAvatar.offsetWidth;
      raceAvatar.style.left = Math.round(progress * maxLeft) + "px";
      racePct.textContent = pct + "%";
    }

    function resetRaceTrack() {
      raceAvatar.style.transition = "none";
      raceAvatar.style.left = "0";
      racePct.textContent = "0%";
      requestAnimationFrame(() => { raceAvatar.style.transition = "left 0.3s ease-out"; });
    }

    // --- Progress storage ---
    const keyFor = id => `tof_lesson_${id}_progress`;
    const saveProgress = (id, idx, bestAcc) => localStorage.setItem(keyFor(id), JSON.stringify({ idx, bestAcc }));
    const loadProgress = id => { try{ return JSON.parse(localStorage.getItem(keyFor(id))||"{}"); }catch{ return {}; } };

    // --- Populate lessons ---
    function populateLessons(){
      lessonSelect.innerHTML = LESSONS.map((L,i)=>`<option value="${L.id}">${i+1}. ${L.title}</option>`).join("");
    }

    // --- Drill state ---
    let curLesson=null, curIdx=0, startTs=0, autoAdvanceTimer=null;
    let totalKeystrokes=0, errorKeystrokes=0, previousInputValue="";

    // Shift-produced characters: map to base key
    const SHIFT_MAP = { ':':';', '"':"'", '<':',', '>':'.', '?':'/' };
    // Keys typed by left hand (use right shift) vs right hand (use left shift)
    const LEFT_KEYS = new Set('qwertasdfgzxcvb12345'.split(''));

    function highlightKeyFor(ch){
      document.querySelectorAll("#keyboard .key").forEach(el=>el.classList.remove("highlight"));
      document.querySelectorAll(".finger").forEach(el=>el.classList.remove("active"));

      if (!ch) return;

      const isUpper = ch !== ch.toLowerCase() && ch === ch.toUpperCase();
      const isShifted = SHIFT_MAP[ch] != null;
      const baseKey = isShifted ? SHIFT_MAP[ch] : ch.toLowerCase();

      // Highlight the base key
      const keyEl = document.querySelector(`#keyboard .key[data-key="${CSS.escape(baseKey)}"]`);
      if (keyEl) {
        keyEl.classList.add("highlight");

        // Highlight the corresponding finger
        const fingerType = keyEl.dataset.finger;
        if (fingerType) {
          const fingerEl = document.querySelector(`.finger[data-finger="${fingerType}"]`);
          if (fingerEl) {
            fingerEl.classList.add("active");
            // Update the key label on the finger
            const keyLabel = fingerEl.querySelector('.finger-key');
            if (keyLabel) keyLabel.textContent = ch.toUpperCase();
          }
        }
      }

      // Highlight the correct Shift key and pinky for uppercase/shifted chars
      if (isUpper || isShifted) {
        const shiftKey = LEFT_KEYS.has(baseKey) ? 'rshift' : 'lshift';
        const shiftEl = document.querySelector(`#keyboard .key[data-key="${shiftKey}"]`);
        if (shiftEl) shiftEl.classList.add("highlight");

        // Highlight the pinky that presses shift
        const shiftFinger = LEFT_KEYS.has(baseKey) ? 'rp' : 'lp';
        const shiftFingerEl = document.querySelector(`.finger[data-finger="${shiftFinger}"]`);
        if (shiftFingerEl) shiftFingerEl.classList.add("active");
      }
    }

    function loadLesson(id){
      curLesson = LESSONS.find(x=>x.id===id) || LESSONS[0];
      lessonText.textContent = curLesson.text;
      const p = loadProgress(curLesson.id);
      curIdx = Math.min(p.idx||0, curLesson.drills.length-1);
      lessonCompleteBanner.style.display = "none";
      loadDrill(curIdx);
      renderLessonTracker();
    }

    function loadDrill(idx){
      if(autoAdvanceTimer){ clearTimeout(autoAdvanceTimer); autoAdvanceTimer=null; }
      curIdx = idx;
      const d = curLesson.drills[idx];
      typedEl.textContent=""; incorrectEl.textContent=""; remainEl.textContent = d.text;
      inputEl.value=""; inputEl.classList.remove("error-state"); startTs=0;
      totalKeystrokes=0; errorKeystrokes=0; previousInputValue="";
      lessonCompleteBanner.style.display = "none";
      highlightKeyFor(d.text.trim()[0]);
      statsEl.textContent = "WPM: 0 · Accuracy: 100% · Errors: 0";
      resetRaceTrack();
      renderDrillNav();
      inputEl.focus();
    }

    // --- Drill navigation UI ---
    function renderDrillNav(){
      const total = curLesson.drills.length;
      const d = curLesson.drills[curIdx];
      const p = loadProgress(curLesson.id);
      const completedIdx = p.idx || 0;

      let html = `<span class="drill-label">Drill ${curIdx+1} of ${total} &mdash; ${d.name}</span>`;
      html += `<div class="drill-dots">`;
      for(let i=0; i<total; i++){
        const cls = i < completedIdx ? "done" : i === curIdx ? "current" : "";
        html += `<span class="drill-dot ${cls}" title="Drill ${i+1}: ${curLesson.drills[i].name}" data-drill="${i}"></span>`;
      }
      html += `</div>`;
      html += `<button id="prevDrillBtn" ${curIdx===0?"disabled":""}>Prev Drill</button>`;
      html += `<button id="nextDrillBtn" ${curIdx>=total-1?"disabled":""}>Next Drill</button>`;

      // Per-drill best accuracy
      const bestAcc = p.bestAcc;
      if(bestAcc != null) html += `<span class="muted" style="margin-left:auto">Best accuracy: ${bestAcc}%</span>`;

      drillNavEl.innerHTML = html;

      // Event listeners
      drillNavEl.querySelector("#prevDrillBtn").addEventListener("click", ()=> prevDrill());
      drillNavEl.querySelector("#nextDrillBtn").addEventListener("click", ()=> nextDrill());
      drillNavEl.querySelectorAll(".drill-dot").forEach(dot=>{
        dot.addEventListener("click", ()=>{
          const i = parseInt(dot.dataset.drill);
          loadDrill(i);
          showLessonBanner("","");
        });
      });
    }

    function prevDrill(){
      if(curIdx > 0){ loadDrill(curIdx-1); showLessonBanner("",""); }
    }
    function nextDrill(){
      if(curIdx < curLesson.drills.length-1){ loadDrill(curIdx+1); showLessonBanner("",""); }
    }

    // --- Next lesson ---
    function nextLesson(){
      const curLessonIdx = LESSONS.findIndex(l=>l.id===curLesson.id);
      if(curLessonIdx < LESSONS.length-1){
        lessonSelect.value = LESSONS[curLessonIdx+1].id;
        loadLesson(LESSONS[curLessonIdx+1].id);
        showLessonBanner("","");
      } else {
        showLessonBanner("success","You've completed all lessons!");
      }
    }
    nextLessonBtn.addEventListener("click", nextLesson);

    // --- Lesson tracker ---
    trackerToggle.addEventListener("click", ()=>{
      const open = trackerGrid.classList.toggle("open");
      trackerToggle.textContent = open ? "Hide Lesson Progress" : "Show Lesson Progress";
    });

    function renderLessonTracker(){
      let html = "";
      LESSONS.forEach((L,i)=>{
        const p = loadProgress(L.id);
        const completedIdx = p.idx || 0;
        const total = L.drills.length;
        const bestAcc = p.bestAcc;
        const allDone = completedIdx >= total - 1 && bestAcc >= 95;
        const inProgress = completedIdx > 0 || bestAcc != null;
        const isActive = curLesson && curLesson.id === L.id;

        let status = "";
        if(allDone) status = '<span style="color:var(--ok)">&#10003;</span>';
        else if(inProgress) status = '<span style="color:var(--accent)">&#9702;</span>';
        else status = '<span style="color:var(--muted)">&middot;</span>';

        const activeCls = isActive ? " active" : "";
        html += `<div class="lesson-row${activeCls}" data-lesson-id="${L.id}">`;
        html += `<span class="lr-num">${i+1}</span>`;
        html += `<span class="lr-title">${L.title}</span>`;
        html += `<span class="lr-drills">${allDone ? total : completedIdx}/${total}</span>`;
        html += `<span class="lr-acc">${bestAcc!=null ? bestAcc+"%" : "&mdash;"}</span>`;
        html += `<span class="lr-status">${status}</span>`;
        html += `</div>`;
      });
      trackerGrid.innerHTML = html;

      trackerGrid.querySelectorAll(".lesson-row").forEach(row=>{
        row.addEventListener("click", ()=>{
          const id = row.dataset.lessonId;
          lessonSelect.value = id;
          loadLesson(id);
          showLessonBanner("","");
        });
      });
    }

    // --- Input handling ---
    inputEl.addEventListener("input", ()=>{
      if(!curLesson) return;
      const target = curLesson.drills[curIdx].text;
      const typed = inputEl.value;
      if(!startTs && typed.length>0) startTs = performance.now();

      // Track keystrokes for accuracy (same as practice page)
      if (typed.length > previousInputValue.length) {
        const addedChars = typed.slice(previousInputValue.length);
        for (let j = 0; j < addedChars.length; j++) {
          const charIndex = previousInputValue.length + j;
          totalKeystrokes++;
          if (addedChars[j] !== target[charIndex]) {
            errorKeystrokes++;
          }
        }
      }
      previousInputValue = typed;

      // Find consecutive correct characters for display
      let correctCount = 0;
      while(correctCount < typed.length && typed[correctCount] === target[correctCount]) correctCount++;

      const hasError = correctCount < typed.length;
      const errorCount = typed.length - correctCount;

      // Update display: correct (green) + incorrect (red) + remaining (muted)
      typedEl.textContent = target.slice(0, correctCount);
      incorrectEl.textContent = target.slice(correctCount, correctCount + errorCount);
      remainEl.textContent = target.slice(correctCount + errorCount);

      // Update input error state
      if (hasError) {
        inputEl.classList.add("error-state");
      } else {
        inputEl.classList.remove("error-state");
      }

      highlightKeyFor(target[correctCount]);
      updateRaceTrack(correctCount, target.length);

      // Use correctCount for metrics (replacing 'i')
      const i = correctCount;

      // metrics (accuracy now matches practice page)
      const elapsed = startTs? (performance.now()-startTs)/1000 : 0;
      const minutes = elapsed/60;
      const grossWPM = minutes>0 ? Math.round(((i)/5)/minutes) : 0;
      const accuracy = totalKeystrokes > 0 ? Math.max(0, 1 - (errorKeystrokes / totalKeystrokes)) : 1;
      const accuracyPercent = Math.round(accuracy * 100);
      statsEl.textContent = `WPM: ${grossWPM} · Accuracy: ${accuracyPercent}% · Errors: ${errorKeystrokes}`;

      // complete drill
      if(i === target.length){
        const finalAcc = accuracyPercent;
        const p = loadProgress(curLesson.id);
        const best = Math.max(p.bestAcc||0, finalAcc);
        const isLastDrill = curIdx >= curLesson.drills.length - 1;

        if(finalAcc >= 95 && !isLastDrill){
          // Passed drill — auto-advance after delay
          showLessonBanner("success",`Drill complete — ${finalAcc}% accuracy! Advancing to next drill...`);
          curIdx += 1;
          saveProgress(curLesson.id, curIdx, best);
          renderDrillNav();
          renderLessonTracker();
          autoAdvanceTimer = setTimeout(()=>{ loadDrill(curIdx); showLessonBanner("",""); }, 1500);
        } else if(finalAcc >= 95 && isLastDrill){
          // Passed last drill — lesson complete
          saveProgress(curLesson.id, curIdx, best);
          showLessonBanner("success",`Drill complete — ${finalAcc}% accuracy!`);
          renderDrillNav();
          renderLessonTracker();
          const curLessonIdx = LESSONS.findIndex(l=>l.id===curLesson.id);
          if(curLessonIdx < LESSONS.length - 1){
            lessonCompleteBanner.style.display = "block";
          } else {
            showLessonBanner("success","Congratulations! You've completed all lessons!");
          }
        } else {
          // Below 95% — stay on this drill
          showLessonBanner("info",`Drill complete — ${finalAcc}% accuracy. Aim for 95%+ to advance. Press Start to retry.`);
          saveProgress(curLesson.id, curIdx, best);
          renderDrillNav();
          renderLessonTracker();
        }
      }
    });

    // --- Controls ---
    lessonSelect.addEventListener("change", ()=> loadLesson(lessonSelect.value));
    startBtn.addEventListener("click", ()=> { loadDrill(curIdx); showLessonBanner("", ""); });
    resetBtn.addEventListener("click", ()=> {
      if(!curLesson) return;
      localStorage.removeItem(`tof_lesson_${curLesson.id}_progress`);
      curIdx = 0;
      loadDrill(curIdx);
      renderLessonTracker();
      showLessonBanner("","Progress cleared for this lesson.");
    });

    // --- Init ---
    initTheme();
    initSkinTone();
    raceAvatar.src = getSelectedAvatar().src;
    populateLessons();
    loadLesson(lessonSelect.value || LESSONS[0].id);
  </script>
</body>
</html>
